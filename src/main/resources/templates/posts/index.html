<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link th:href="@{/coreui.css}" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/5.2.0/css/bootstrap.min.css">
    <link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css">
    <title>Man page</title>
</head>
<body>
<div th:replace="partials/header.html :: header"></div>
<div class="body" style="margin-top: 20px;">
    <div class="container-lg">
        <div class="card mb-4">
            <div class="card-header">list data</div>
            <div class="card-body">
                <div class="btn-group btn-group-sm" role="group" aria-label="basic">
                    <a th:href="@{~/posts/create}" class="btn btn-primary">Create</a>
                    <button id="generateReport" class="btn btn-success">Download Report</button>
                    <button id="selectDelete" class="btn btn-danger">Delete select</button>
                </div>
                <table id="data-posts" class="table table-striped" style="width:100%">
                    <thead>
                    <tr>
                        <th style="text-align: center">
                            <input type="checkbox" id="select_all" />
                        </th>
                        <th>id</th>
                        <th>title</th>
                        <th>active</th>
                        <th>actions</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <th></th>
                        <th>id</th>
                        <th>title</th>
                        <th>active</th>
                        <th>actions</th>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>
<script th:src="@{/coreui.js}"></script>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
<script th:inline="javascript">

$(document).ready(function () {
     var tableWidget = $('#data-posts').DataTable({
     processing: true,
     serverSide: true,
     ajax: {
         url: 'http://localhost:8000/api/posts',
         type: 'POST',
         contentType: 'application/json',
         data: function (d) {
             return JSON.stringify(d);
         }
     },
     columns: [
         { data: null,defaultContent: ''},
         { data: 'id' },
         { data: 'title' },
         { data: 'active' },
         {data:null,defaultContent:"<a class='btn btn-secondary btn-sm' href='#'>View</a>&nbsp;&nbsp;<a class='btn btn-secondary btn-sm' id='edit-form' href='#'>Edit</a>&nbsp;&nbsp;<a class='btn btn-secondary btn-sm' href='#' id='destroy'>Destroy</a>"}
     ],
     "columnDefs": [
        {
            orderable: false,
            className: 'select-checkbox',
            targets: 0
        }
    ],
    select: {
        style: 'multi+shift',
        selector: 'td:first-child'
    }
 });

    var arr = [];

    tableWidget.on('click', 'tr td:first-child', function () {
        if ($(this).hasClass('selected')) {
            $(this).removeClass('selected');
            var data = tableWidget.row($(this).parents('tr')).data();
            arr.pop();
        } else {
            tableWidget.$('tr.selected').removeClass('selected');
            var data = tableWidget.row($(this).parents('tr')).data();
            arr.push(data.id);
            $(this).addClass('selected');
        }
    });


$("#selectDelete").on('click',function(){
    if(arr.length > 0 ){
      $.ajax({
         method: "DELETE",
         contentType: 'application/json',
         url: "http://localhost:8000/api/posts/deleteAll",
         data: JSON.stringify({"ids":arr})
     }).done(function(data) {
         tableWidget.ajax.reload();
         arr.length = 0;
     });

    }
  });


  tableWidget.on('click','#select_all',function(){
         var isChecked = $(this).is(':checked');
         if(isChecked){
            tableWidget.rows().select();
            const ids = tableWidget.rows().data().toArray().flatMap((d)=>d.id);
            ids.forEach(addItems);
         }else {
           tableWidget.rows().deselect();
           arr.length = 0;
         }
    });


  function addItems(item, index) {
      arr.push(item);
  }

  $("#generateReport").on('click',function(){
      tableWidget.ajax.reload();
      $.ajax({
         method: "POST",
         contentType: 'application/json',
         url: "http://localhost:8000/api/posts/generate-report",
         data: tableWidget.ajax.params(),
         xhrFields: {
             responseType: 'blob'
         },
     }).done(function(data) {
        var a = document.createElement('a');
        var url = window.URL.createObjectURL(data);
        a.href = url;
        a.download = 'posts.xlsx';
        document.body.append(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
     });
  });

   $('#data-posts tbody').on('click', '#edit-form', function () {
        var data = tableWidget.row($(this).parents('tr')).data();
        var url = 'http://localhost:8000/posts/edit/'+data.id;
        window.location.href=url;
   });


   $('#data-posts tbody').on('click', '#destroy', function (e) {
        e.preventDefault();
        var data = tableWidget.row($(this).parents('tr')).data();
        var urlApi = 'http://localhost:8000/api/posts/destroy/'+data.id;
        $.ajax({
         method: "DELETE",
         contentType: 'application/json',
         url: urlApi,
     }).done(function(response) {
        console.log(response);
        tableWidget.ajax.reload();
     });
   });

  });
</script>
</body>
</html>